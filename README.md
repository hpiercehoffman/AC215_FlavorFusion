AC215: FlavorFusion
==============================

## Presentation Video ##
- [Add Link]

## Blog Post ##
- [Add Link]

<p align="center">
  <img src="https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/src/frontend-simple/logo.png" width=50% height=50% />
</p>

Project Organization
------------
      ├── LICENSE
      ├── README.md
      ├── notebooks
      │   ├── run_ethnicolr.ipynb
      |   └── pruning_evaluation.ipynb
      ├── references
      │   └── references.md
      ├── reports
      │   ├── milestone2.md
      │   ├── milestone3.md
      │   ├── milestone4.md
      │   └── milestone5.md
      ├── images
      │   └── [Screenshots showing project functionality]
      ├── requirements.txt
      └── src
            ├── docker-volumes
            │   ├── google-data.dvc
            │   ├── lsars-data.dvc
            │   └── notebooks
            │       ├── process_google.ipynb
            │       ├── process_lsars.ipynb
            │       └── Evaluation_Example.ipynb
            ├── preprocess_google
            │   ├── Dockerfile
            │   ├── Pipfile
            │   ├── Pipfile.lock
            │   ├── preprocess.py
            │   ├── cors.py
            │   ├── utils.py
            │   ├── docker-compose.yml
            │   └── docker-shell.sh	
            ├── preprocess_lsars
            │   ├── Dockerfile
            │   ├── Pipfile
            │   ├── Pipfile.lock
            │   ├── preprocess_lsars.py
            │   ├── docker-compose.yml
            │   └── docker-shell.sh
            ├── inference_cloud_functions
            │   ├── inference_zero_shot.py
            │   ├── inference_trained.py
            │   ├── inference_pruned.py
            │   └── requirements.txt
            ├── frontend-simple
            │   ├── docker-shell.sh
            │   ├── index.html
            │   ├── Dockerfile
            │   └── logo.png
            ├── deployment
            │   ├── deploy-cluster-short.yml
            │   ├── deploy-create-instance.yml
            │   ├── deploy-docker-images.yml
            │   ├── deploy-k8s-cluster.yml
            │   ├── deploy-provision-instance.yml
            │   ├── deploy-setup-containers.yml
            │   ├── deploy-setup-webserver.yml
            │   ├── docker-entrypoint.sh
            │   ├── docker-shell.sh
            │   ├── inventory.yml
            │   └── nginx-conf
            │       └── nginx
            │           └── nginx.conf
            ├── api-service
            │   ├── docker-shell.sh
            │   ├── docker-entrypoint.sh
            │   ├── Dockerfile
            │   ├── Pipfile
            │   ├── Pipfile.lock
            │   └── api
            │       ├── service.py
            │       ├── data_download.py
            │       ├── model_inference.py
            │       └── openapi.json
            └── train
                ├── Dockerfile
                ├── Pipfile
                ├── Pipfile.lock
                ├── train_serverless.py
                ├── config.yml
                ├── requirements.txt
                └── submit_job.sh

--------
# AC215 - Final Project

**Team Members**   
Varun Ullanat, Hannah Pierce-Hoffman

**Group Name**   
FlavorFusion

**Project**   
In this project, we aim to build an app that captures cultural differences in Google resturaunt reviews using abstractive summaries generated by a large language model.

For a full list of external references used in this project, please refer to our [reference document](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/references/references.md).

## Deliverables Breakdown ##
For information on each of the following topics, see the relevant linked milestone.
- [Milestone 2](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/reports/milestone2.md):
    - Data preprocessing, Label Studio, and DVC
    - `preprocess_google` and `preprocess_lsars` Docker containers
- [Milestone 3](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/reports/milestone3.md):
    - Model training, VM setup, and experiment tracking
    - `train` Docker container
- [Milestone 4](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/reports/milestone4.md):
    - Model optimization and model deployment
    - Scripts in the `inference_cloud_functions` directory
- [Milestone 5](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/reports/milestone5.md):
    - Frontend interface, API development, and solution architecture
    - `frontend_simple` and `api-service` containers
- Milestone 6 (this page):
    - Automation, scaling, and CI/CD
    - `deployment` container

### Completed App ###

### Deployment: Ansible ###
In this milestone, we used [Ansible](https://www.ansible.com/) to automate the process of deploying our app on a GCP VM. Below, we describe how to run each of our Ansible playbooks to complete the deployment process. For manual deployment steps, see our [Milestone 5 Setup Notes](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/reports/milestone5.md#setup-notes). 
- **Run the deployment container:** To run the deployment container with Ansible and Kubectl installed, enter the following commands:  
`cd src/deployment`    
`sh docker-shell.sh`    
If running this container for the first time, see the [Setup Notes](https://github.com/hpiercehoffman/AC215_FlavorFusion/tree/main#setup-notes) section for additional setup instructions.
- **Build and push Docker images:** We start by building the `frontend-simple` and `api-service` Docker images and pushing them to Google Container Registry. We tag both images with the current timestamp so they can be linked together. To run these steps, type the following command inside the deployment container:     
`ansible-playbook deploy-docker-images.yml -i inventory.yml`    
Note that running this command for the first time may take ~30 minutes, since the `api-service` container is fairly large and takes a long time to push to GCR.
- **Set up a GCP VM:** We create a GCP VM with a mounted persistent disk for storage. We allow HTTP traffic on port 80, and HTTPS traffic on port 443. To run this step, type the following command:    
`ansible-playbook deploy-provision-instance.yml -i inventory.yml`
- **Set up containers on the VM:** We copy our secrets files (GCP credentials and WandB key) to the VM so they can be mounted to our Docker containers. We pull the containers from GCR and run them on port 3000 (frontend) and port 9000 (API service). To run these steps, type the following command:         
`ansible-playbook deploy-setup-containers.yml -i inventory.yml`
- **Set up Nginx:** We use Nginx as a reverse proxy to handle incoming HTTP traffic on port 80. Nginx also passes traffic between the frontend and the API service. To run this step, type the following command:    
`ansible-playbook deploy-setup-webserver.yml -i inventory.yml`

At this point, three containers should be running on the GCP VM: `frontend`, `api-service`, and `nginx`. If you want to verify that all containers are running, you can SSH to the VM from the GCP console and type: `sudo docker container ls`. You can access the app in your browser using the external IP of the VM: `http://<VM External IP>/`

### Scaling: Kubernetes ###
We deploy our app as a Kubernetes cluster to effectively handle concurrent requests from multiple clients. To create and launch a Kubernetes cluster, run the following Ansible command within the `deployment` Docker container:     
`ansible-playbook deploy-k8s-cluster.yml -i inventory.yml --extra-vars cluster_state=present`

This Ansible playbook executes the following steps:
- Create a [Kubernetes](https://kubernetes.io/) cluster which autoscales to have either 1 or 2 nodes. Each node is a `n2d-standard-2` type VM with 30 GB of disk space.
- Create a namespace for the cluster, and update the local Kubernetes configuration to recognize the newly created cluster.
- Set up a Nginx ingress to manage external access to cluster services. 
- Create a persistent volume which can be used by the cluster pods for extra storage.
- Create Kubernetes secrets to store our GCP credentials (used to access data in buckets) and our WandB key (used to download our trained model).
- Deploy the frontend and API containers as services within each node of the cluster. Grant the API service access to the persistent volume as well as the two secrets.
- Wait for the Nginx ingress service to come up. Output the Nginx IP address to the console so it can be used to access the cluster.

This playbook takes 5-10 minutes to run, since cluster creation takes a long time. Once the playbook is finished running, the deployed app can be accessed at `http://<Nginx Ingress IP>.sslip.io`. 

We also include a second Ansible playbook to run all of the above steps except creating the cluster. This playbook assumes that a cluster named `flavor-fusion-cluster` is already present. To run this playbook, type the following command in the `deployment` Docker container:    
`ansible-playbook deploy-cluster-short.yml -i inventory.yml --extra-vars cluster_state=present`

Below, we show some screenshots of our app running on Kubernetes.

**Kubernetes cluster with node pool**
<img src="https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/images/kubernetes_cluster_and_nodepool.png" width=75% height=75% />

**Kubernetes pods and processes running**     
<img src="https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/images/kubectl_everything_running.png" width=50% height=50% />    
To produce the above output, run the command `kubectl get all --all-namespaces` in the `deployment` Docker container.    

**Accessing the app from the Nginx ingress IP address**     
<img src="https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/main/images/kubernetes_wandb_working.png" width=75% height=75% />      

### CI/CD: Github Actions ###






--------
# Setup Notes #

### Additional Ansible and Kubernetes Setup ###
(Add info about setting up secrets, ssh auth, and inventory.yml)

### Notebooks ###    
This directory contains code which doesn't belong to a specific container:
- `pruning_evaluation.ipynb`: Code to evaluate and compute benchmark statistics for a base versus pruned model.
- `run_ethnicolor.ipynb`: Code to predict reviewers' ethnic background using the [Ethnicolr](https://ethnicolr.readthedocs.io/) python package.

# References #

For a full list of external references used in this project, please refer to our [reference document](https://github.com/hpiercehoffman/AC215_FlavorFusion/blob/milestone5/references/references.md).

